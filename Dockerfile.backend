# Backend Dockerfile for FastAPI + ONNX Inference
FROM python:3.12-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    libgl1 \
    libglib2.0-0 \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± íŒŒì¼ ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.docker.txt .
RUN pip install --no-cache-dir -r requirements.docker.txt && \
    find /usr/local/lib/python3.12 -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12 -type d -name 'tests' -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12 -type d -name 'test' -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12 -type f -name '*.pyc' -delete && \
    find /usr/local/lib/python3.12 -type f -name '*.pyo' -delete && \
    rm -rf /root/.cache/pip

# âœ… Rembg u2net ëª¨ë¸ì„ ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œ (cold start ìµœì í™”)
RUN mkdir -p /root/.u2net && \
    python -c "from rembg import new_session; print('ğŸ”¥ Downloading u2net model...'); new_session('u2net'); print('âœ… u2net model downloaded and cached')"

# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
COPY api_server.py .
COPY inference.py .
COPY preprocess.py .
COPY config.yaml .
COPY Bestefficientnet.onnx .
COPY Bestefficientnet.onnx.data .
COPY DefaultTucson.jpg .

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# ì„œë²„ ì‹¤í–‰
CMD ["python", "api_server.py"]
